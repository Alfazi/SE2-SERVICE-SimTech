<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order_id');
        const orderIdInput = document.getElementById('order-id');
        const profilePicture = document.getElementById('profile-picture');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const orderBtn = document.getElementById('order-btn');
        const userId = localStorage.getItem('userId'); // Ambil userId dari localStorage
        
        if (!userId) {
            alert('Silakan login terlebih dahulu.');
            window.location.href = '/login';
            return;
        }
        
        if (orderId) {
            orderIdInput.value = orderId;
        } else {
            alert('Nomor pesanan tidak ditemukan.');
            window.location.href = '/orders';
        }
        const paymentForm = document.getElementById('payment-form');
        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const paymentMethod = document.getElementById('payment-method').value;
            if (!paymentMethod) {
                alert('Silakan pilih metode pembayaran.');
                return;
            }
            try {
                const response = await fetch(`/api/payments`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'user-id': localStorage.getItem('userId'), // Tambahkan user-id
                    },
                    body: JSON.stringify({ 
                        orderId: orderId, 
                        paymentMethod: paymentMethod,
                    }),
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Pembayaran berhasil!');
                    window.location.href = '/orders';
                } else {
                    alert(`Gagal melakukan pembayaran: ${result.message}`);
                }
            } catch (error) {
                console.error('Error processing payment:', error);
                alert('Terjadi kesalahan saat memproses pembayaran.');
            }
        });

        try {
            // Periksa apakah pengguna telah login
            const response = await fetch('/auth/user');
            const data = await response.json();

            if (data.success && data.user) {
                isLoggedIn = true;
                profilePicture.src = data.user.profilePicture || 'images/default-profile.png';
                localStorage.setItem('userId', data.user.id); // Simpan userId
                localStorage.setItem('userEmail', data.user.email); // Simpan email jika diperlukan
                console.log('index-html');
                console.log('User-id', data.user.id);
                console.log('userEmail',data.user.email);
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                orderBtn.style.display = 'block';
            } else {
                profilePicture.src = 'images/default-profile.png';
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                orderBtn.style.display = 'block';
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');
            }

            profilePicture.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('active');
            });

            loginBtn.addEventListener('click', () => {
                window.location.href = '/login';
            });

            orderBtn.addEventListener('click', () => {
                window.location.href = '/orders';
            });

            logoutBtn.addEventListener('click', async () => {
                await fetch('/logout', { method: 'POST' });
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');
                window.location.href = '/'; // Redirect ke homepage
            });
        } catch (err) {
            console.error('Error checking login status:', err);
        }
    });
</script>