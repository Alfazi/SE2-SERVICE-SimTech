<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const profilePicture = document.getElementById('profile-picture');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const productCarousel = document.querySelector('#pc-ready .product-carousel');

        let isLoggedIn = false;

        // Fungsi untuk memuat produk dari API berdasarkan tipe "PC Ready"
        const loadProducts = async () => {
            try {
                const response = await fetch('/api/products'); // Panggil endpoint API produk
                const products = await response.json();

                // Filter produk untuk hanya mengambil item_type = "PC Ready"
                const pcReadyProducts = products.filter(product => product.item_type === 'PC Ready');

                if (pcReadyProducts.length === 0) {
                    productCarousel.innerHTML = '<p>Tidak ada produk PC Ready tersedia.</p>';
                    return;
                }

                productCarousel.innerHTML = ''; // Kosongkan elemen sebelum menambahkan produk baru

                // Tambahkan produk ke elemen HTML
                pcReadyProducts.forEach((product) => {
                    const productCard = document.createElement('div');
                    productCard.classList.add('product-card');

                    productCard.innerHTML = `
                        <img src="${product.image_url || 'images/default.jpg'}" alt="${product.item_name}">
                        <div class="name">${product.item_name}</div>
                        <div class="price">Rp ${new Intl.NumberFormat('id-ID').format(product.price)}</div>
                        <button class="detail-btn" data-id="${product.item_id}">View Details</button>
                        <button class="buy-btn" data-id="${product.item_id}" data-name="${product.item_name}">Beli</button>
                    `;

                    productCarousel.appendChild(productCard);
                });

                // Event listener untuk tombol beli
                document.querySelectorAll('.buy-btn').forEach((button) => {
                    button.addEventListener('click', (e) => {
                        const productId = button.dataset.id;
                        const productName = button.dataset.name;

                        if (!isLoggedIn) {
                            alert('Silakan login terlebih dahulu untuk membeli barang.');
                            window.location.href = '/login';
                        } else {
                            addToCart(productId, productName);
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading products:', error);
                productCarousel.innerHTML = '<p>Gagal memuat produk. Silakan coba lagi nanti.</p>';
            }
        };

        // Fungsi untuk menambahkan produk ke keranjang
        const addToCart = (productId, productName) => {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart.push({ productId, productName });
            localStorage.setItem('cart', JSON.stringify(cart));
            alert(`${productName} berhasil ditambahkan ke keranjang!`);
            window.location.href = 'cart.html';
        };

        // Periksa apakah pengguna telah login
        try {
            const response = await fetch('/auth/user');
            const data = await response.json();
            isLoggedIn = data.success && data.user;
        } catch (err) {
            console.error('Error checking login status:', err);
        }

        // Muat produk untuk PC Ready
        await loadProducts();

        // User Profile and Dropdown Logic
        try {
            const response = await fetch('/auth/user');
            const data = await response.json();

            if (data.success && data.user) {
                profilePicture.src = data.user.profilePicture || 'images/default-profile.png';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
            } else {
                profilePicture.src = 'images/default-profile.png';
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
            }

            profilePicture.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('active');
            });

            loginBtn.addEventListener('click', () => {
                window.location.href = '/login';
            });

            logoutBtn.addEventListener('click', async () => {
                await fetch('/logout', { method: 'POST' });
                window.location.href = '/'; // Redirect ke homepage
            });

            document.addEventListener('click', () => {
                dropdownMenu.classList.remove('active');
            });
        } catch (err) {
            console.error('Error:', err);
        }
    });
</script>
